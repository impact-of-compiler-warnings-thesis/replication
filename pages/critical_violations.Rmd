---
author: Albin Johansson & Carl Holmberg
date: 2023
---

```{r cv-include-setup, include=FALSE}
source(knitr::purl('pages/setup.Rmd', output = tempfile()))
```

# Critical Violations

This section covers the analysis relating to the "critical violations" metric.

## Prepare Data

```{r cv-prepare-data}
# The model seed is the date that the analysis was conducted
model_seed <- 20230322

# Returns a list of standardized data necessary for the analysis.
create_critical_violations_data <- function(data) {
  list(
    critical_violations_kloc_std=scale(data$critical_violations_kloc),
                contributors_std=scale(data$contributors),
                       stars_std=scale(data$stars),
                       files_std=scale(data$files),
                        size_std=scale(data$loc),
                         age_std=scale(get_age(data$created_at))
  )
}

# Prepare data with all categories as factors (1-11).
data <- create_critical_violations_data(df)
data$category <- factor(df$category)

# Prepare data that factors on the presence of compiler warnings
data_factor_uses_warnings <- create_critical_violations_data(df)
data_factor_uses_warnings$category <- factor(uses_warnings(df$category))
```

## Define Models

### CV1

```{r cv-model-1, message=FALSE}
fit_model_cv1 <- function(name, data) {
  fit_model(name,
            "critical_violations_kloc_std ~ 0 + category",
            c(
               prior(normal(0, 1), class = b),
               prior(exponential(1), class = sigma)
             ),
            data,
            model_seed)
}

cv1 <- fit_model_cv1("cv1", data)
```

### CV2

```{r cv-model-2, message=FALSE}
fit_model_cv2 <- function(name, data) {
  fit_model(name,
            "critical_violations_kloc_std ~ 0 + category + contributors_std",
            c(
               prior(normal(0, 1), class = b),
               prior(normal(0, 1), class=b, coef="contributors_std"),
               prior(exponential(1), class = sigma)
             ),
            data,
            model_seed)
}

cv2 <- fit_model_cv2("cv2", data)
```

### CV3

```{r cv-model-3, message=FALSE}
fit_model_cv3 <- function(name, data) {
  fit_model(name,
            "critical_violations_kloc_std ~ 0 + category + stars_std",
            c(
               prior(normal(0, 1), class = b),
               prior(normal(0, 1), class=b, coef="stars_std"),
               prior(exponential(1), class = sigma)
             ),
            data,
            model_seed)
}

cv3 <- fit_model_cv3("cv3", data)
```

### CV4

```{r cv-model-4, message=FALSE}
fit_model_cv4 <- function(name, data) {
  fit_model(name,
            "critical_violations_kloc_std ~ 0 + category + files_std",
            c(
               prior(normal(0, 1), class = b),
               prior(normal(0, 1), class=b, coef="files_std"),
               prior(exponential(1), class = sigma)
             ),
            data,
            model_seed)
}

cv4 <- fit_model_cv4("cv4", data)
```

### CV5

```{r cv-model-5, message=FALSE}
fit_model_cv5 <- function(name, data) {
  fit_model(name,
            "critical_violations_kloc_std ~ 0 + category + age_std",
            c(
               prior(normal(0, 1), class = b),
               prior(normal(0, 1), class=b, coef="age_std"),
               prior(exponential(1), class = sigma)
             ),
            data,
            model_seed)
}

cv5 <- fit_model_cv5("cv5", data)
```

### CV6

```{r cv-model-6, message=FALSE}
fit_model_cv6 <- function(name, data) {
  fit_model(name,
            "critical_violations_kloc_std ~ 0 + category + size_std",
            c(
               prior(normal(0, 1), class = b),
               prior(normal(0, 1), class=b, coef="size_std"),
               prior(exponential(1), class = sigma)
             ),
            data,
            model_seed)
}

cv6 <- fit_model_cv6("cv6", data)
```

### CV7

```{r cv-model-7, message=FALSE}
fit_model_cv7 <- function(name, data) {
  fit_model(name,
            "critical_violations_kloc_std ~ 0 + category + contributors_std + stars_std",
            c(
               prior(normal(0, 1), class = b),
               prior(normal(0, 1), class=b, coef="contributors_std"),
               prior(normal(0, 1), class=b, coef="stars_std"),
               prior(exponential(1), class = sigma)
             ),
            data,
            model_seed)
}

cv7 <- fit_model_cv7("cv7", data)
```

### CV8

```{r cv-model-8, message=FALSE}
fit_model_cv8 <- function(name, data) {
  fit_model(name,
            "critical_violations_kloc_std ~ 0 + category + contributors_std + age_std",
            c(
               prior(normal(0, 1), class = b),
               prior(normal(0, 1), class=b, coef="contributors_std"),
               prior(normal(0, 1), class=b, coef="age_std"),
               prior(exponential(1), class = sigma)
             ),
            data,
            model_seed)
}

cv8 <- fit_model_cv8("cv8", data)
```

## Compare models

```{r cv-model-comparisons}
cv1 <- add_criterion(cv1, criterion="loo", moment_match=TRUE)
cv2 <- add_criterion(cv2, criterion="loo", moment_match=TRUE)
cv3 <- add_criterion(cv3, criterion="loo", moment_match=TRUE)
cv4 <- add_criterion(cv4, criterion="loo", moment_match=TRUE)
cv5 <- add_criterion(cv5, criterion="loo", moment_match=TRUE)
cv6 <- add_criterion(cv6, criterion="loo", moment_match=TRUE)
cv7 <- add_criterion(cv7, criterion="loo", moment_match=TRUE)
cv8 <- add_criterion(cv8, criterion="loo", moment_match=TRUE)

print(loo_compare(cv1, cv2, cv3, cv4, cv5, cv6, cv7, cv8, criterion="loo"),
      simplify=FALSE)
```

## Determine natural scale values

```{r cv-determine-natural-scale-values}
summary(cv1)
print(create_natural_scale_summary_df(cv1, df$critical_violations_kloc))
```

## Intervals of major categories

```{r cv-plot-intervals-of-major-categories, fig.width=6, fig.height=2.8, message=FALSE}
plot_intervals_of_major_categories(cv1) +
  labs(title="CV1", x="Critical violations per KLOC (std)")
```

## Warnings versus no warnings

```{r cv-warnings-vs-no-warnings, fig.width=6, fig.height=2, message=FALSE}
cv1_factor_uses_warnings <- fit_model_cv1("cv1_factor_uses_warnings",
                                          data_factor_uses_warnings)

plot_intervals_of_categories(cv1_factor_uses_warnings) +
  labs(title="CV1", x="Critical violations per KLOC (std)") +
  scale_y_discrete(labels=c(
                     "b_category1"="No warnings",
                     "b_category2"="Any warnings"
                   ))
```
