---
author: Albin Johansson & Carl Holmberg
date: 2023
---

```{r td-include-setup, include=FALSE}
source(knitr::purl('pages/setup.Rmd', output = tempfile()))
```

# Technical Debt

This section covers the analysis relating to the technical debt metric.

## Prepare data

```{r}
model_seed <- 20230302

create_tech_debt_data <- function(data) {
  list(
       tech_debt_std=scale(data$sqale_debt_ratio),
    contributors_std=scale(data$contributors),
           stars_std=scale(data$stars),
             age_std=scale(get_age(data$created_at)),
           files_std=scale(data$files),
            size_std=scale(data$loc)
  )
}

data <- create_tech_debt_data(df)
data$category <- factor(df$category)

data_factor_uses_warnings <- create_tech_debt_data(df)
data_factor_uses_warnings$category <- factor(uses_warnings(df$category))
```

## Define Models

### TD1

```{r td-model-1, message=FALSE}
fit_model_td1 <- function(name, data) {
  fit_model(name,
            "tech_debt_std ~ 0 + category",
            c(
              prior(normal(0, 1), class=b),
              prior(exponential(1), class=sigma)
            ),
            data,
            model_seed)
}

td1 <- fit_model_td1("td1", data)
```

### TD2

```{r td-model-2, message=FALSE}
fit_model_td2 <- function(name, data) {
  fit_model(name,
            "tech_debt_std ~ 0 + category + files_std",
            c(
              prior(normal(0, 1), class=b),
              prior(normal(0, 1), class=b, coef="files_std"),
              prior(exponential(1), class=sigma)
            ),
            data,
            model_seed)
}

td2 <- fit_model_td2("td2", data)
```

### TD3

```{r td-model-3, message=FALSE}
fit_model_td3 <- function(name, data) {
  fit_model(name,
            "tech_debt_std ~ 0 + category + contributors_std",
            c(
              prior(normal(0, 1), class=b),
              prior(normal(0, 1), class=b, coef="contributors_std"),
              prior(exponential(1), class=sigma)
            ),
            data,
            model_seed)
}

td3 <- fit_model_td3("td3", data)
```

### TD4

```{r td-model-4, message=FALSE}
fit_model_td4 <- function(name, data) {
  fit_model(name,
            "tech_debt_std ~ 0 + category + size_std",
            c(
              prior(normal(0, 1), class=b),
              prior(normal(0, 1), class=b, coef="size_std"),
              prior(exponential(1), class=sigma)
            ),
            data,
            model_seed)
}

td4 <- fit_model_td4("td4", data)
```

### TD5

```{r td-model-5, message=FALSE}
fit_model_td5 <- function(name, data) {
  fit_model(name,
            "tech_debt_std ~ 0 + category + age_std",
            c(
              prior(normal(0, 1), class=b),
              prior(normal(0, 1), class=b, coef="age_std"),
              prior(exponential(1), class=sigma)
            ),
            data,
            model_seed)
}

td5 <- fit_model_td5("td5", data)
```

### TD6

```{r td-model-6, message=FALSE}
fit_model_td6 <- function(name, data) {
  fit_model(name,
            "tech_debt_std ~ 0 + category + stars_std",
            c(
              prior(normal(0, 1), class=b),
              prior(normal(0, 1), class=b, coef="stars_std"),
              prior(exponential(1), class=sigma)
            ),
            data,
            model_seed)
}

td6 <- fit_model_td6("td6", data)
```

### TD7

```{r td-model-7, message=FALSE}
fit_model_td7 <- function(name, data) {
  fit_model(name,
            "tech_debt_std ~ 0 + category + contributors_std + files_std",
            c(
              prior(normal(0, 1), class=b),
              prior(normal(0, 1), class=b, coef="contributors_std"),
              prior(normal(0, 1), class=b, coef="files_std"),
              prior(exponential(1), class=sigma)
            ),
            data,
            model_seed)
}

td7 <- fit_model_td7("td7", data)
```

### TD8

```{r td-model-8, message=FALSE}
fit_model_td8 <- function(name, data) {
  fit_model(name,
            "tech_debt_std ~ 0 + category + contributors_std + stars_std",
            c(
              prior(normal(0, 1), class=b),
              prior(normal(0, 1), class=b, coef="contributors_std"),
              prior(normal(0, 1), class=b, coef="stars_std"),
              prior(exponential(1), class=sigma)
            ),
            data,
            model_seed)
}

td8 <- fit_model_td8("td8", data)
```

## Compare models

```{r td-compare-models, message=FALSE}
td1 <- add_criterion(td1, "loo", moment_match=TRUE)
td2 <- add_criterion(td2, "loo", moment_match=TRUE)
td3 <- add_criterion(td3, "loo", moment_match=TRUE)
td4 <- add_criterion(td4, "loo", moment_match=TRUE)
td5 <- add_criterion(td5, "loo", moment_match=TRUE)
td6 <- add_criterion(td6, "loo", moment_match=TRUE)
td7 <- add_criterion(td7, "loo", moment_match=TRUE)
td8 <- add_criterion(td8, "loo", moment_match=TRUE)

print(loo_compare(td1, td2, td3, td4, td5, td6, td7, td8, criterion="loo"),
      simplify=FALSE)
```

## Determine natural scale values

```{r td-determine-natural-scale-values, message=FALSE}
summary(td1)
print(create_natural_scale_summary_df(td1, df$sqale_debt_ratio))
```

## Intervals of major categories

```{r td-major-categories, fig.width=6, fig.height=2.8, message=FALSE}
plot_intervals_of_major_categories(td1) + labs(title="TD1", x="Technical Debt Ratio (std)")
```

## Warnings versus no warnings

```{r td-warnings-no-warnings, fig.width=6, fig.height=2.8, message=FALSE}
td1_factor_uses_warnings <- fit_model_td1("td1_factor_uses_warnings", data_factor_uses_warnings)

plot_intervals_of_categories(td1_factor_uses_warnings) + 
  labs(title="TD1", x="Technical Debt Ratio (std)") +
  scale_y_discrete(labels=c("b_category1"="No warnings", "b_category2"="Any warnings"))
```

## Without outliers

```{r td-without-outliers, fig.width=6, fig.height=2.8, message=FALSE}
df_culled <- df
df_culled <- df_culled[df_culled$name != "clipp",]

culled_data <- create_tech_debt_data(df_culled)
culled_data$category <- factor(df_culled$category)

td1_culled <- fit_model_td1("td1_no_outliers", culled_data)

summary(td1_culled)
print(create_natural_scale_summary_df(td1_culled, df_culled$sqale_debt_ratio))

plot_intervals_of_major_categories(td1_culled) + 
  labs(title="TD1 (culled)", x="Technical Debt Ratio (std)")

culled_data_factor_uses_warnings <- create_tech_debt_data(df_culled)
culled_data_factor_uses_warnings$category <- factor(uses_warnings(df_culled$category))

td1_culled_factor_uses_warnings <-
  fit_model_td1("td1_data_no_outliers_factor_uses_warnings",
                culled_data_factor_uses_warnings)

plot_intervals_of_categories(td1_culled_factor_uses_warnings) +
   labs(title="TD1 (culled)", x="Technical Debt Ratio (std)") +
   scale_y_discrete(labels=c(
                     "b_category1"="No warnings",
                     "b_category2"="Any warnings"
  ))
```
