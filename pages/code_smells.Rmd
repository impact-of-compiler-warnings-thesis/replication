---
author: Albin Johansson & Carl Holmberg
date: 2023
---

```{r cs-include-setup, include=FALSE}
source(knitr::purl('pages/setup.Rmd', output = tempfile()))
```

# Code Smells

This section covers the analysis relating to the "code smells" metric.

## Prepare data

```{r cs-prepare-data}
# The model seed is the date that the analysis was conducted
model_seed <- 20230302

# Returns a list of standardized data necessary for the analysis.
create_code_smells_data <- function(data) {
  list(
    code_smells_kloc_std=scale(data$code_smells_kloc),
        contributors_std=scale(data$contributors),
               stars_std=scale(data$stars),
                 age_std=scale(get_age(data$created_at))
  )
}

# Prepare data with all categories as factors (1-11).
data <- create_code_smells_data(df)
data$category <- factor(df$category)

# Prepare data that factors on the presence of compiler warnings
data_factor_uses_warnings <- create_code_smells_data(df)
data_factor_uses_warnings$category <- factor(uses_warnings(df$category))
```

## Define models

### CS1

```{r cs-model-1}
fit_model_cs1 <- function(name, data) {
  fit_model(name,
            "code_smells_kloc_std ~ 0 + category",
            c(
              prior(normal(0, 1), class=b),
              prior(exponential(1), class=sigma)
            ),
            data,
            model_seed)
}

cs1 <- fit_model_cs1("cs1", data)
```

### CS2

```{r cs-model-2}
fit_model_cs2 <- function(name, data) {
  fit_model(name,
            "code_smells_kloc_std ~ 0 + category + contributors_std",
            c(
              prior(normal(0, 1), class=b),
              prior(normal(0, 1), class=b, coef="contributors_std"),
              prior(exponential(1), class=sigma)
            ),
            data,
            model_seed)
}

cs2 <- fit_model_cs2("cs2", data)
```

### CS3

```{r cs-model-3}
fit_model_cs3 <- function(name, data) {
  fit_model(name,
            "code_smells_kloc_std ~ 0 + category + stars_std",
            c(
              prior(normal(0, 1), class=b),
              prior(normal(0, 1), class=b, coef="stars_std"),
              prior(exponential(1), class=sigma)
            ),
            data,
            model_seed)
}

cs3 <- fit_model_cs3("cs3", data)
```

### CS4

```{r cs-model-4}
fit_model_cs4 <- function(name, data) {
  fit_model(name,
            "code_smells_kloc_std ~ 0 + category + age_std",
            c(
              prior(normal(0, 1), class=b),
              prior(normal(0, 1), class=b, coef="age_std"),
              prior(exponential(1), class=sigma)
            ),
            data,
            model_seed)
}

cs4 <- fit_model_cs4("cs4", data)
```

### CS5

```{r cs-model-5}
fit_model_cs5 <- function(name, data) {
  fit_model(name,
            "code_smells_kloc_std ~ 0 + category + contributors_std + stars_std",
            c(
              prior(normal(0, 1), class=b),
              prior(normal(0, 1), class=b, coef="contributors_std"),
              prior(normal(0, 1), class=b, coef="stars_std"),
              prior(exponential(1), class=sigma)
            ),
            data,
            model_seed)
}

cs5 <- fit_model_cs5("cs5", data)
```

### CS6

```{r cs-model-6}
fit_model_cs6 <- function(name, data) {
  fit_model(name,
            "code_smells_kloc_std ~ 0 + category + contributors_std + age_std",
            c(
              prior(normal(0, 1), class=b),
              prior(normal(0, 1), class=b, coef="contributors_std"),
              prior(normal(0, 1), class=b, coef="age_std"),
              prior(exponential(1), class=sigma)
            ),
            data,
            model_seed)
}

cs6 <- fit_model_cs6("cs6", data)
```

### CS7

```{r cs-model-7}
fit_model_cs7 <- function(name, data) {
  fit_model(name,
            "code_smells_kloc_std ~ 0 + category + contributors_std + stars_std + age_std",
            c(
              prior(normal(0, 1), class=b),
              prior(normal(0, 1), class=b, coef="contributors_std"),
              prior(normal(0, 1), class=b, coef="stars_std"),
              prior(normal(0, 1), class=b, coef="age_std"),
              prior(exponential(1), class=sigma)
            ),
            data,
            model_seed)
}

cs7 <- fit_model_cs7("cs7", data)
```

## Compare models

```{r cs-compare-models}
cs1 <- add_criterion(cs1, criterion="loo", moment_match=TRUE)
cs2 <- add_criterion(cs2, criterion="loo", moment_match=TRUE)
cs3 <- add_criterion(cs3, criterion="loo", moment_match=TRUE)
cs4 <- add_criterion(cs4, criterion="loo", moment_match=TRUE)
cs5 <- add_criterion(cs5, criterion="loo", moment_match=TRUE)
cs6 <- add_criterion(cs6, criterion="loo", moment_match=TRUE)
cs7 <- add_criterion(cs7, criterion="loo", moment_match=TRUE)

print(loo_compare(cs1, cs2, cs3, cs4, cs5, cs6, cs7, criterion="loo"),
      simplify=FALSE)
```

## Determine natural scale means

```{r cs-determine-natural-scale-means}
summary(cs6)

cs6_std_means <- c(0.40, 0.38, -0.05, 0.13, -0.14, -0.22, -0.47, 0.01, -0.15, -0.32, -0.19)
determine_natural_scale_means(cs6_std_means, df$code_smells_kloc)
```

## Intervals of major categories

```{r cs-plot-intervals-of-major-categories, fig.width=6, fig.height=2.8, message=FALSE}
plot_intervals_of_major_categories(cs6) +
  labs(title="CS6", x="Code smells per KLOC (std)")
```

## Warnings versus no warnings

```{r cs-warnings-vs-no-warnings, fig.width=6, fig.height=2, message=FALSE}
# Fit CS6 using data that uses binary factor for usage of warnings
cs6_factor_uses_warnings <- fit_model_cs6("cs6_factor_uses_warnings",
                                          data_factor_uses_warnings)

plot_intervals_of_categories(cs6_factor_uses_warnings) +
  labs(title="CS6", x="Code smells per KLOC (std)") +
  scale_y_discrete(labels=c(
                     "b_category1"="No warnings",
                     "b_category2"="Any warnings"
                   ))
```

## Without outliers

There are outliers in category AEP and AEP+, "clipp" and "hana", which bias the analysis results.
Here we remove these samples and fit CS2 to the trimmed data.

```{r cs-remove-outliers, message=FALSE}
# Prepare version of data frame without the outliers
df_no_outliers <- df
df_no_outliers <- df_no_outliers[df_no_outliers$name != "clipp",]
df_no_outliers <- df_no_outliers[df_no_outliers$name != "hana",]

# Prepare data for analysis
data_no_outliers <- create_code_smells_data(df_no_outliers)
data_no_outliers$category <- factor(df_no_outliers$category)

# Fit CS6 using the trimmed data
cs6_no_outliers <- fit_model_cs6("cs6_no_outliers", data_no_outliers)
summary(cs6_no_outliers)
```

```{r cs-plot-intervals-no-outliers, fig.width=6, fig.height=2.8, message=FALSE}
plot_intervals_of_major_categories(cs6_no_outliers) +
  labs(title="CS6 (no outliers)", x="Code smells per KLOC (std)")
```

```{r cs-plot-intervals-factor-uses-warnings-no-outliers, fig.width=6, fig.height=2, message=FALSE}
data_no_outliers_factor_uses_warnings <- create_code_smells_data(df_no_outliers)
data_no_outliers_factor_uses_warnings$category <- 
  factor(uses_warnings(df_no_outliers$category))

# Fit CS6 using the trimmed data, but with binary warning category factor
cs6_no_outliers_factor_uses_warnings <-
  fit_model_cs6("cs6_data_no_outliers_factor_uses_warnings",
                data_no_outliers_factor_uses_warnings)

plot_intervals_of_categories(cs6_no_outliers_factor_uses_warnings) +
  labs(title="CS6 (no outliers)", x="Code smells per KLOC (std)") +
  scale_y_discrete(labels=c(
                     "b_category1"="No warnings",
                     "b_category2"="Any warnings"
                   ))
```
